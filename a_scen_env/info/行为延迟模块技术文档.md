# 认知延迟模块可视化功能使用说明

## 概述

`CognitiveDelayModule` 现在具备完整的可视化功能，能够记录和分析动作延迟效果，生成详细的时变图表和统计报告。

## 功能特性

### 🎯 核心功能
- **动作延迟**: 模拟人类驾驶员的反应延迟
- **动作平滑**: 避免突然的控制变化
- **PPO模式检测**: 仅在PPO专家模式下应用认知效果
- **数据记录**: 自动记录所有动作处理过程
- **可视化生成**: 生成多维度分析图表

### 📊 可视化内容
1. **油门/刹车动作时变图**: 对比原始动作、平滑后动作和延迟后动作
2. **转向动作时变图**: 展示转向控制的延迟效果
3. **延迟效果差异分析**: 量化延迟对动作的影响
4. **统计信息面板**: 显示关键配置参数和运行统计

## 使用方法

### 1. 基本配置

```python
from cognitive_delay_module import CognitiveDelayModule

# 创建延迟模块（启用可视化）
delay_module = CognitiveDelayModule(
    delay_steps=3,              # 延迟步数
    enable_smoothing=True,      # 启用动作平滑
    smoothing_factor=0.4,       # 平滑系数 [0,1]
    enable_visualization=True   # 启用可视化记录
)
```

### 2. 动作处理

```python
# 在环境的step()方法中处理动作
original_action = [throttle, steering]
processed_action = delay_module.process_action(
    action=original_action,
    is_ppo_mode=True  # 仅PPO模式下应用延迟
)
```

### 3. 生成可视化

```python
# 在环境关闭时生成可视化图表
output_file = delay_module.generate_delay_visualization(
    output_dir="./results/cognitive_delay",  # 推荐使用专门的子目录
    session_name="experiment_001"
)
```

## 集成到主环境

在 `TrajectoryReplayEnvCognitive` 中，延迟模块已经完全集成：

### 配置示例
```python
COGNITIVE_CONFIG = {
    'delay': {
        'enable': True,
        'delay_steps': 2,
        'enable_smoothing': True,
        'smoothing_factor': 0.3
    }
}

env = TrajectoryReplayEnvCognitive(
    trajectory_data,
    config={
        'enable_cognitive_modules': True,
        'cognitive_config': COGNITIVE_CONFIG
    }
)
```

### 自动可视化生成
- 环境关闭时自动生成延迟效果分析图表
- 保存到 `fig_cog/cognitive_analysis_{timestamp}/cognitive_delay/` 目录下
- 生成PNG图表和TXT报告文件

## 输出文件说明

### 目录结构
```
fig_cog/
└── cognitive_analysis_{timestamp}/
    └── cognitive_delay/
        ├── {session_name}_delay_analysis.png
        └── {session_name}_delay_report.txt
```

### 图表文件 (`*_delay_analysis.png`)
- **2x2子图布局**:
  - 左上: 油门/刹车动作对比
  - 右上: 转向动作对比  
  - 左下: 延迟差异分析
  - 右下: 统计信息面板

### 报告文件 (`*_delay_report.txt`)
- 模块配置参数
- 运行统计信息
- 延迟效果定量分析
- 详细说明文档

## 参数说明

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `delay_steps` | int | 2 | 延迟步数，越大延迟越明显 |
| `enable_smoothing` | bool | True | 是否启用动作平滑 |
| `smoothing_factor` | float | 0.3 | 平滑系数，[0,1]，越大平滑效果越强 |
| `enable_visualization` | bool | True | 是否启用可视化数据记录 |

## 统计指标

### 延迟效果测量
- **延迟差异**: `|原始动作 - 延迟动作|`
- **平均延迟**: PPO模式下的平均延迟差异
- **最大延迟**: 单步最大延迟差异
- **激活率**: PPO模式占总步数的比例

### 性能指标
- 总仿真步数
- PPO模式步数统计
- 数据记录完整性

## 使用建议

### 1. 参数调优
- **delay_steps**: 建议2-5步，模拟150-500ms的人类反应延迟
- **smoothing_factor**: 建议0.2-0.5，过大会导致响应迟钝

### 2. 分析重点
- 关注PPO模式下的延迟效果
- 对比不同配置下的延迟差异
- 分析延迟对驾驶行为的影响

### 3. 故障排除
- 如果可视化生成失败，检查输出目录权限
- 中文显示问题会自动降级为英文标签
- 确保有足够的数据记录（建议>50步）

## 示例输出

典型的延迟分析结果：
```
延迟模块统计信息:
  延迟步数: 3
  动作平滑: 启用
  平滑系数: 0.400
  记录步数: 200

延迟效果分析 (PPO模式):
  平均油门延迟差异: 0.096400
  平均转向延迟差异: 0.159000
  最大油门延迟差异: 0.705100
  最大转向延迟差异: 0.832000
```

这表明延迟模块成功模拟了人类驾驶员的延迟特性，为认知建模提供了重要的数据支持。 